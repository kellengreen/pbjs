<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>pb.js</title>
    <style>body{background-color:hsl(0, 0%, 15%)}</style>
</head>
<body>
    <script>

const pb = {};

(() => {
    class PbStorage {

        static constructHandler(_, args) {
            const target = args[0] || {};
            const handler = {
                get: this.getHandler.bind(this),
                set: this.setHandler.bind(this),
                deleteProperty: this.deleteHandler.bind(this),
            };
            target[this.listeners] = {};

            target = this.proxify()

            return new Proxy(target, handler);
        }

        static proxifyObject(object) {
            const keys = Reflect.ownKeys(object);
            keys.forEach(key => {
                if (key !== this.liseners) {
                    const val = object[key];
                    if (this.isPrimitive(val) === false) {
                        
                    }
                }
            });
        }

        static getHandler(target, key) {
            console.log(`get: ${key}`);
            return target[key];
        }

        static setHandler(target, key, val) {
            console.log(`set: ${key}=${val}`);
            
            if (this.isPrimitive(val)) {
                target[key] = val;
            } else {
                const newTarget = val;
                const newTargetKeys = Reflect.ownKeys(val); 
                newTargetKeys.forEach(newTargetKey => {
                    newTarget[newTargetKey] = this.setHandler(newTarget, newTargetKey, target);
                });
                target[key] = new this(val, key, target);
            }

            return true;
        }

        static setObject(object) {
            const keys = Reflect.ownKeys(object);
            keys.forEach(key => {

            });
        }

        static deleteHandler(target, key) {
            this.callListeners(target, key);
            delete target.key;
            return true;
        }

        static isPrimitive(val) {
            return val === null || typeof val !== 'object';
        }

        static path(target, key) {
            const keys = [];
            while (target[this.symbol] !== undefined) {
                keys.unshift(target[Pair.symbol]);
                target = target[Pair.symbol].parent;
            }
            keys.push(key);
            return keys.join('.');
        }

        static listen(target, path, callback) {
            console.log(`listen: ${path}`);
            const keys = path.split('.');
        }

        static ignore(target, path, callback) {
            console.log(`ignore: ${path}`);

        }

        static callListeners(target, key) {
            if (target[this.listeners][key] !== undefined) {
                const val = target[key];
                target[this.listeners][key].forEach(callback => {
                    callback(val);
                });
            }
        }

        static addListener(target, key, callback) {
            if (target[this.listeners][key] === undefined) {
                target[this.listeners][key] = new Set();
            }
            target[this.listeners][key].add(callback);
        }

        static removeListener(target, key, callback) {
            return (
                target[this.listeners][key] !== undefined && 
                target[this.listeners][key].delete(callback) === true
            );
        }
    }

    PbStorage.listeners = Symbol('listeners');

    pb.Storage = new Proxy(PbStorage, {
        construct: PbStorage.constructHandler.bind(PbStorage),
    });

})();

const storage = new pb.Storage();
storage.foo = 'foo';
pb.Storage.listen(storage, 'foo', val => {
    console.log(`changed: ${val}`);
});
storage.foo = 'bar';

    </script>
</body>
</html>
