<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>pb.js</title>
</head>
<body>
<script src="bin/reflect.js"></script>
<script>
    'use strict';
    var pb = {};

    pb.proxy = {

        utils: Symbol('Proxy utility properties'),

        handler: {

            get: function(obj, key) {

                console.log('Get: ' + key);

                if (typeof key !== 'string') {
                    return obj[key];
                }

                const keys = path.split('.'),
                      last = keys.length - 1;

                for (var i = 0; i < keys.length; i++) {
                    key = keys[i];

                    if (obj.hasOwnProperty(key)) {
                        if (i === last) {
                            if (val === undefined) {
                                return obj[key];
                            } else {
                                return obj[key] = val;
                            }
                        } else if (typeof obj === 'object') {
                            obj = obj[key];
                            continue;
                        }
                    }

                    throw ReferenceError('"' + key + '" does not exist in "' + path + '"');
                }
            },

            set: function(obj, key, val) {

                console.log('SET: ' + key + ' = ' + val);

                if (typeof val === 'object') {
                    val = pb.proxy.create(val);
                    val[pb.proxy.utils].path = (obj[pb.proxy.utils].path ? obj[pb.proxy.utils].path + '.' : '') + key;
                }

                return obj[key] = val;
            }
        },

        create: function(obj) {

            Object.defineProperty(obj, pb.proxy.utils, {
                value: {
                    path: '',
                    parent: obj,

                    byPath: function (path) {

                        var obj = this.parent;
                        const keys = path.split('.'),
                              last = keys.length - 1;

                        for (var i = 0, key; i < keys.length; i++) {
                            key = keys[i];

                            if (obj.hasOwnProperty(key)) {
                                if (i === last) {
                                    if (val === undefined) {
                                        return obj[key];
                                    } else {
                                        return obj[key] = val;
                                    }
                                } else if (typeof obj === 'object') {
                                    obj = obj[key];
                                    continue;
                                }
                            }

                            throw ReferenceError('"' + key + '" does not exist in "' + path + '"');
                        }
                    },

                    setByPath: function (path, val) {

                        var obj = this.parent;
                        const keys = path.split('.'),
                              last = keys.length - 1;

                        for (var i = 0, key; i < keys.length; i++) {
                            key = keys[i];

                            if (obj.hasOwnProperty(key)) {
                                if (i === last) {
                                    return obj[key];
                                } else if (typeof obj === 'object') {
                                    obj = obj[key];
                                    continue;
                                }
                            }

                            throw ReferenceError('"' + key + '" does not exist in "' + path + '"');
                        }
                    }
                }
            });

            return new Proxy(obj, pb.proxy.handler);
        }
    };

    var a = pb.proxy.create({});
    a.foo = 'bar';
    console.dir(a.foo);

</script>
</body>
</html>
