<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>pb.js</title>
</head>
<body>
<script src="bin/reflect.js"></script>
<script>
    'use strict';
    var pb = {};

    pb.proxy = {

        utils: Symbol('Proxy utility properties'),

        handler: {

            get: function(obj, key) {

                console.log('Get: ' + key);
                const pair = obj[pb.proxy.utils].fromKey(key);
                return pair.obj[pair.key];
            },

            set: function(obj, key, val) {

                console.log('SET: ' + key + ' = ' + val);

                if (typeof val === 'object') {
                    val = pb.proxy.create(val);
                    val[pb.proxy.utils].path = (obj[pb.proxy.utils].path ? obj[pb.proxy.utils].path + '.' : '') + key;
                }

                const pair = obj[pb.proxy.utils].fromKey(key);
                return pair.obj[pair.key] = val;
            }
        },

        create: function(obj) {

            Object.defineProperty(obj, pb.proxy.utils, {
                value: {
                    path: '',
                    parent: obj,
                    fromKey: function (key) {
                        var obj =  this.parent;

                        if (typeof key === 'string') {
                            const keys = path.split('.'),
                                  last = keys.length - 1;

                            for (var i = 0; i < keys.length; i++) {
                                key = keys[i];
                                if (i === last) {
                                    break;
                                }
                                obj = obj[key];
                            }
                        }

                        return {
                            obj: obj,
                            key: key
                        }
                    }
                }
            });

            return new Proxy(obj, pb.proxy.handler);
        }
    };

    var a = pb.proxy.create({});
    a.foo = 'bar';
    console.dir(a.foo);

</script>
</body>
</html>
