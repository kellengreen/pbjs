<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>pb.js</title>
</head>
<body>
<script>
    'use strict';

    var h = {
        get: function(obj, key) {
            console.log('get - ' + key);
            return key in obj ? obj[key] : obj.$[key];
        },
        set: function(obj, key, val) {

            if (key in obj) {
                return obj[key] = val;
            } else {

                console.log('set - ' + key + ': ' + val);

                if (typeof val === 'object') {
                    val = pbObj(val);
                    val.dir = (obj.dir ? obj.dir + '.' : '') + key;
                }

                return obj.$[key] = val;
            }
        }
    };

    function pbObj(obj) {
        Object.defineProperty(obj, '$', {
            value: new obj.constructor(),
            writable: true
        });
        Object.defineProperty(obj, 'dir', {
            value: '',
            writable: true
        });
        return new Proxy(obj, h);
    }

    var a = pbObj({});
    a.b = {};
    a.foo = 'bar';
    a.b.c = [];
    console.dir(a);
</script>
</body>
</html>
